unit UCriancas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Data.Win.ADODB, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls;

type
  TfrmGerCriancas = class(TForm)
    lblTitulo: TLabel;
    btnCadCrianca: TButton;
    btnEdtCrianca: TButton;
    btnExcCriancas: TButton;
    dbgCriancas: TDBGrid;
    qryCriancas: TADOQuery;
    dtsCriancas: TDataSource;
    btnAtualizar: TButton;
    lblTotalCriancas: TLabel;
    qryOperacoesCrianca: TADOQuery;
    procedure pesquisarCriancas;
    procedure ExcluirCrianca;
    procedure btnAtualizarClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure btnExcCriancasClick(Sender: TObject);
    procedure btnCadCriancaClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmGerCriancas: TfrmGerCriancas;

implementation

{$R *.dfm}

uses UMenu, UCadCrianca;

procedure TfrmGerCriancas.btnAtualizarClick(Sender: TObject);
    begin
        pesquisarCriancas;
    end;

procedure TfrmGerCriancas.btnCadCriancaClick(Sender: TObject);
    begin
        frmCadCrianca:=TfrmCadCrianca.create(self,'c','0');
        frmCadCrianca.showModal;
    end;

procedure TfrmGerCriancas.btnExcCriancasClick(Sender: TObject);
    begin
        try
         ExcluirCrianca;
        except
           on e:exception do
           ShowMessage('Erro ao excluir criança: '+e.Message);
        end;
    end;

procedure TfrmGerCriancas.ExcluirCrianca;
var botaoSelecionado:integer;
    begin
        botaoSelecionado:= messagedlg('Deseja excluir o a criança '+dbgCriancas.DataSource.DataSet.FieldByName('nomeCrianca').AsString+'?',mtConfirmation, [mbYes,mbCancel], 0);
        if botaoSelecionado=6 then
            begin
              qryOperacoesCrianca.Close;
              with qryOperacoesCrianca do
                begin
                  qryOperacoesCrianca.SQL.Clear;
                  qryOperacoesCrianca.SQL.Add('delete crianca');
                  qryOperacoesCrianca.SQL.Add('where idCrianca='+dbgCriancas.DataSource.DataSet.FieldByName('idCrianca').AsString);
                end;
              if qryOperacoesCrianca.ExecSQL=1 then
                begin
                    ShowMessage('Excluido com sucesso!');
                    pesquisarCriancas;
                end;

         end;
    end;

procedure TfrmGerCriancas.FormCreate(Sender: TObject);
    begin
        qryCriancas.Close;
        pesquisarCriancas;
    end;

procedure TfrmGerCriancas.pesquisarCriancas;
    begin
        qryCriancas.Close;
        with qryCriancas do
          begin
              qryCriancas.SQL.Clear;
              qryCriancas.SQL.Add('select c.idCrianca, c.nomeCrianca, DATEDIFF(YEAR,c.dtNascCrianca,GETDATE()) as dtNascCrianca , c.nisCrianca, c.territorioCrianca');
              qryCriancas.SQL.Add('	    ,g.nomeGrupo                       ');
              qryCriancas.SQL.Add('from crianca c                           ');
              qryCriancas.SQL.Add('inner join grupo g on g.idGrupo=c.idGrupo');
              qryCriancas.SQL.Add('where g.idVisitador='+frmMenu.idUsuario);
          end;
        qryCriancas.Open;
        lblTotalCriancas.Caption:= 'Total de crianças: '+IntToStr(qryCriancas.RecordCount);
    end;

end.
